MAGISK_MODULE_HOMEPAGE=https://busybox.net/
MAGISK_MODULE_DESCRIPTION="Tiny versions of many common UNIX utilities into a single small executable"
MAGISK_MODULE_LICENSE="GPL-2.0"
MAGISK_MODULE_ESSENTIAL=yes
MAGISK_MODULE_VERSION=1.30.1
MAGISK_MODULE_REVISION=1
MAGISK_MODULE_SHA256=3d1d04a4dbd34048f4794815a5c48ebb9eb53c5277e09ffffc060323b95dfbdc
MAGISK_MODULE_SRCURL=https://busybox.net/downloads/busybox-${MAGISK_MODULE_VERSION}.tar.bz2
MAGISK_MODULE_BUILD_IN_SRC=yes

# We replace env in the old coreutils package:
MAGISK_MODULE_CONFLICTS="coreutils (<< 8.25-4)"

magisk_step_pre_configure() {
	CFLAGS+=" -llog" # Android system liblog.so for syslog
}

setup_toolchain() {
	export MUSL_PATH=/usr/local/musl
	export PATH=$MUSL_PATH/bin:$PATH
	export CROSS_COMPILE=/usr/local/musl/bin/aarch64-linux-musl-

	export MUSL_BIN=$MUSL_PATH/bin/aarch64-linux-musl

	export AS=${MUSL_BIN}-as
	export CC=$MUSL_BIN-gcc
	export CXX=$MUSL_BIN-c++

	export AR=$MUSL_BIN-ar
	export CPP=${MUSL_BIN}-cpp
	export HOSTCC=gcc
	export LD=$MUSL_BIN-ld
	export OBJCOPY=$MUSL_BIN-objcopy
	export OBJDUMP=$MUSL_BIN-objdump
	export RANLIB=$MUSL_BIN-ranlib
	export READELF=$MUSL_BIN-readelf
	export STRIP=$MUSL_BIN-strip
}

magisk_step_configure() {
	cp $MAGISK_MODULE_BUILDER_DIR/busybox.config .config
	echo "CONFIG_SYSROOT=\"$MAGISK_STANDALONE_TOOLCHAIN/sysroot\"" >> .config
	echo "CONFIG_PREFIX=\"$MAGISK_PREFIX\"" >> .config
	echo "CONFIG_CROSS_COMPILER_PREFIX=\"aarch64-linux-musl-\"" >> .config
	echo "CONFIG_FEATURE_CROND_DIR=\"$MAGISK_PREFIX/var/spool/cron\"" >> .config
	echo "CONFIG_SV_DEFAULT_SERVICE_DIR=\"$MAGISK_PREFIX/var/service\"" >> .config
	echo "CONFIG_STATIC=y" >> .config
	echo "CONFIG_PIE=n" >> .config
	make oldconfig
}

magisk_step_make() {
	setup_toolchain
	CC=/usr/local/musl/bin/aarch64-linux-musl-gcc make
}

mmagisk_step_post_make_install() {
	if [ "$MAGISK_DEBUG" == "true" ]; then
		install busybox_unstripped $PREFIX/bin/busybox
	fi
	# Create symlinks in $PREFIX/bin/applets to $PREFIX/bin/busybox
	rm -Rf $MAGISK_PREFIX/bin/applets
	mkdir -p $MAGISK_PREFIX/bin/applets
	cd $MAGISK_PREFIX/bin/applets
	for f in $(cat $MAGISK_MODULE_SRCDIR/busybox.links); do ln -s ../busybox $(basename $f); done

	# The 'env' applet is special in that it go into $PREFIX/bin:
	cd $MAGISK_PREFIX/bin
	ln -f -s busybox env

	# Install busybox man page
	mkdir -p $MAGISK_PREFIX/share/man/man1
	cp $MAGISK_MODULE_SRCDIR/docs/busybox.1 $MAGISK_PREFIX/share/man/man1

	# Needed for 'crontab -e' to work out of the box:
	local _CRONTABS=$MAGISK_PREFIX/var/spool/cron/crontabs
	mkdir -p $_CRONTABS
	echo "Used by the busybox crontab and crond tools" > $_CRONTABS/README.magisk

	# Setup some services
	mkdir -p $MAGISK_PREFIX/var/service
	cd $MAGISK_PREFIX/var/service
	mkdir -p ftpd telnetd
	echo '#!/bin/sh' > ftpd/run
	echo 'exec tcpsvd -vE 0.0.0.0 8021 ftpd /data/data/com.magisk/files/home' >> ftpd/run
	echo '#!/bin/sh' > telnetd/run
	echo 'exec telnetd -F' >> telnetd/run
	chmod +x */run
}
